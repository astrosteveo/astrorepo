name: Package and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true

jobs:
  package-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Create dist directory
        run: mkdir -p dist

      - name: Package all skills
        run: |
          echo "ðŸ“¦ Packaging skills..."

          for skill in skills/*/; do
            if [ -d "$skill" ]; then
              skill_name=$(basename "$skill")
              echo ""
              echo "Packaging $skill_name..."

              if python tools/package_skill.py "$skill" dist/; then
                echo "âœ… $skill_name packaged successfully"
              else
                echo "âŒ Failed to package $skill_name"
                exit 1
              fi
            fi
          done

          echo ""
          echo "ðŸŽ‰ All skills packaged successfully!"
          ls -lh dist/*.zip

      - name: Generate checksums
        run: |
          cd dist
          sha256sum *.zip > checksums.txt
          cat checksums.txt

      - name: Create release notes
        run: |
          cat > dist/RELEASE_NOTES.md << 'EOF'
          # AstroRepo Release ${{ github.ref_name }}

          ## ðŸ“¦ Available Skills

          EOF

          for skill in skills/*/; do
            if [ -f "$skill/SKILL.md" ]; then
              skill_name=$(basename "$skill")
              description=$(grep -m1 "^description:" "$skill/SKILL.md" | sed 's/description: //')
              echo "- **$skill_name** - $description" >> dist/RELEASE_NOTES.md
            fi
          done

          cat >> dist/RELEASE_NOTES.md << 'EOF'

          ## ðŸ“¥ Installation

          ### Install entire marketplace:
          \`\`\`bash
          /plugin add marketplace https://github.com/astrosteveo/astrorepo
          \`\`\`

          ### Install individual skill:
          \`\`\`bash
          wget https://github.com/astrosteveo/astrorepo/releases/download/${{ github.ref_name }}/SKILL_NAME.zip
          unzip SKILL_NAME.zip -d ~/.claude/skills/
          \`\`\`

          ## ðŸ“Š Stats

          - Total Skills: $(ls -1 skills/ | wc -l)
          - Package Size: $(du -sh dist/*.zip | awk '{sum += $1} END {print sum}')

          ## âœ¨ What's New

          See [CHANGELOG.md](https://github.com/astrosteveo/astrorepo/blob/main/CHANGELOG.md) for details.

          ---

          **Full Changelog**: https://github.com/astrosteveo/astrorepo/compare/...HEAD
          EOF

          cat dist/RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.zip
            dist/checksums.txt
            dist/RELEASE_NOTES.md
          body_path: dist/RELEASE_NOTES.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        if: success()
        run: |
          echo "## ðŸŽ‰ Release Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packaged Skills" >> $GITHUB_STEP_SUMMARY
          ls -1 dist/*.zip | sed 's/dist\//- /' | sed 's/.zip$//' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download" >> $GITHUB_STEP_SUMMARY
          echo "https://github.com/astrosteveo/astrorepo/releases/tag/${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
